

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>libf0.salience &mdash; libf0 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/libf0.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index_yin.html">yin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../index_pyin.html">pyin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../index_salience.html">salience</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../index_swipe.html">swipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../index_swipe_slim.html">swipe_slim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../index_utils.html">utils</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">libf0</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>libf0.salience</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for libf0.salience</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">| Description: libf0 salience-based F0 estimation implementation</span>
<span class="sd">| Author: Sebastian Rosenzweig, Simon Schwär, Meinard Müller</span>
<span class="sd">| License: The MIT license, https://opensource.org/licenses/MIT</span>
<span class="sd">| This file is part of libf0.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">librosa</span> <span class="kn">import</span> <span class="n">stft</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span><span class="p">,</span> <span class="n">linalg</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>


<div class="viewcode-block" id="salience"><a class="viewcode-back" href="../../index_salience.html#libf0.salience.salience">[docs]</a><span class="k">def</span> <span class="nf">salience</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Fs</span><span class="o">=</span><span class="mi">22050</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">F_min</span><span class="o">=</span><span class="mf">55.0</span><span class="p">,</span> <span class="n">F_max</span><span class="o">=</span><span class="mf">1760.0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">num_harm</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">freq_smooth_len</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">constraint_region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_low</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">score_high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of a salience-based F0-estimation algorithm using pitch contours, inspired by Melodia.</span>

<span class="sd">    .. [#] Justin Salamon and Emilia Gómez,</span>
<span class="sd">       &quot;Melody Extraction From Polyphonic Music Signals Using Pitch Contour Characteristics.&quot;</span>
<span class="sd">       IEEE Transactions on Audio, Speech, and Language Processing, vol. 20, no. 6, pp. 1759–1770, Aug. 2012.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ndarray</span>
<span class="sd">        Audio signal</span>
<span class="sd">    Fs : int</span>
<span class="sd">        Sampling rate</span>
<span class="sd">    N : int</span>
<span class="sd">        Window size</span>
<span class="sd">    H : int</span>
<span class="sd">        Hop size</span>
<span class="sd">    F_min : float or int</span>
<span class="sd">        Minimal frequency</span>
<span class="sd">    F_max : float or int</span>
<span class="sd">        Maximal frequency</span>
<span class="sd">    R : int</span>
<span class="sd">        Frequency resolution given in cents</span>
<span class="sd">    num_harm : int</span>
<span class="sd">        Number of harmonics (Default value = 10)</span>
<span class="sd">    freq_smooth_len : int</span>
<span class="sd">        Filter length for vertical smoothing (Default value = 11)</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Weighting parameter for harmonics (Default value = 0.9)</span>
<span class="sd">    gamma : float</span>
<span class="sd">        Logarithmic compression factor (Default value = 0.0)</span>
<span class="sd">    constraint_region : None or ndarray</span>
<span class="sd">        Constraint regions, row-format: (t_start_sec, t_end_sec, f_start_hz, f_end,hz)</span>
<span class="sd">        (Default value = None)</span>
<span class="sd">    tol : int</span>
<span class="sd">        Tolerance parameter for transition matrix (Default value = 5)</span>
<span class="sd">    score_low : float</span>
<span class="sd">        Score (low) for transition matrix (Default value = 0.01)</span>
<span class="sd">    score_high : float</span>
<span class="sd">        Score (high) for transition matrix (Default value = 1.0)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    f0 : ndarray</span>
<span class="sd">        Estimated F0-trajectory</span>
<span class="sd">    T_coef: ndarray</span>
<span class="sd">        Time axis</span>
<span class="sd">    sal: ndarray</span>
<span class="sd">        Salience value of estimated F0</span>
<span class="sd">    </span>
<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    [FMP] Notebook: C8/C8S2_SalienceRepresentation.ipynb</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># compute salience representation via instantaneous frequency and harmonic summation</span>
    <span class="n">Z</span><span class="p">,</span> <span class="n">F_coef_hertz</span> <span class="o">=</span> <span class="n">compute_salience_rep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Fs</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">F_min</span><span class="o">=</span><span class="n">F_min</span><span class="p">,</span> <span class="n">F_max</span><span class="o">=</span><span class="n">F_max</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span>
                                           <span class="n">num_harm</span><span class="o">=</span><span class="n">num_harm</span><span class="p">,</span> <span class="n">freq_smooth_len</span><span class="o">=</span><span class="n">freq_smooth_len</span><span class="p">,</span>
                                           <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>

    <span class="c1"># compute trajectory via dynamic programming</span>
    <span class="n">T_coef</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">H</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fs</span>
    <span class="n">index_CR</span> <span class="o">=</span> <span class="n">compute_trajectory_cr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">T_coef</span><span class="p">,</span> <span class="n">F_coef_hertz</span><span class="p">,</span> <span class="n">constraint_region</span><span class="p">,</span>
                                     <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">score_low</span><span class="o">=</span><span class="n">score_low</span><span class="p">,</span> <span class="n">score_high</span><span class="o">=</span><span class="n">score_high</span><span class="p">)</span>

    <span class="n">traj</span> <span class="o">=</span> <span class="n">F_coef_hertz</span><span class="p">[</span><span class="n">index_CR</span><span class="p">]</span>
    <span class="n">traj</span><span class="p">[</span><span class="n">index_CR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># compute salience value</span>
    <span class="n">Z_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Z_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">Z_max</span><span class="p">)</span>
    <span class="n">sal</span> <span class="o">=</span> <span class="n">Z_norm</span><span class="p">[</span><span class="n">index_CR</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">sal</span><span class="p">[</span><span class="n">traj</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">traj</span><span class="p">,</span> <span class="n">T_coef</span><span class="p">,</span> <span class="n">sal</span></div>


<div class="viewcode-block" id="compute_salience_rep"><a class="viewcode-back" href="../../index_salience.html#libf0.salience.compute_salience_rep">[docs]</a><span class="k">def</span> <span class="nf">compute_salience_rep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Fs</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">F_min</span><span class="p">,</span> <span class="n">F_max</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">num_harm</span><span class="p">,</span> <span class="n">freq_smooth_len</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute salience representation [FMP, Eq. (8.56)]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ndarray</span>
<span class="sd">        Audio signal</span>
<span class="sd">    Fs : int</span>
<span class="sd">        Sampling rate</span>
<span class="sd">    N : int</span>
<span class="sd">        Window size</span>
<span class="sd">    H : int</span>
<span class="sd">        Hop size</span>
<span class="sd">    F_min : float or int</span>
<span class="sd">        Minimal frequency</span>
<span class="sd">    F_max : float or int</span>
<span class="sd">        Maximal frequency</span>
<span class="sd">    R : int</span>
<span class="sd">        Frequency resolution given in cents</span>
<span class="sd">    num_harm : int</span>
<span class="sd">        Number of harmonics</span>
<span class="sd">    freq_smooth_len : int</span>
<span class="sd">        Filter length for vertical smoothing</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Weighting parameter for harmonics</span>
<span class="sd">    gamma : float</span>
<span class="sd">        Logarithmic compression factor</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Z : ndarray</span>
<span class="sd">        Salience representation</span>
<span class="sd">    F_coef_hertz : ndarray</span>
<span class="sd">        Frequency axis in Hz</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    [FMP] Notebook: C8/C8S2_SalienceRepresentation.ipynb</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">stft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_fft</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">win_length</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">Y_LF_IF_bin</span><span class="p">,</span> <span class="n">F_coef_hertz</span> <span class="o">=</span> <span class="n">compute_y_lf_if_bin_eff</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Fs</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">F_min</span><span class="p">,</span> <span class="n">F_max</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    
    <span class="c1"># smoothing</span>
    <span class="n">Y_LF_IF_bin</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">convolve1d</span><span class="p">(</span><span class="n">Y_LF_IF_bin</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">(</span><span class="n">freq_smooth_len</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    
    <span class="n">Z</span> <span class="o">=</span> <span class="n">compute_salience_from_logfreq_spec</span><span class="p">(</span><span class="n">Y_LF_IF_bin</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">n_harmonics</span><span class="o">=</span><span class="n">num_harm</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Z</span><span class="p">,</span> <span class="n">F_coef_hertz</span></div>


<div class="viewcode-block" id="compute_y_lf_if_bin_eff"><a class="viewcode-back" href="../../index_salience.html#libf0.salience.compute_y_lf_if_bin_eff">[docs]</a><span class="k">def</span> <span class="nf">compute_y_lf_if_bin_eff</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Fs</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">F_min</span><span class="p">,</span> <span class="n">F_max</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Binned Log-frequency Spectrogram with variable frequency resolution based on instantaneous frequency,</span>
<span class="sd">    more efficient implementation than FMP</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray</span>
<span class="sd">        Complex spectrogram</span>
<span class="sd">    Fs : int</span>
<span class="sd">        Sampling rate in Hz</span>
<span class="sd">    N : int</span>
<span class="sd">        Window size</span>
<span class="sd">    H : int</span>
<span class="sd">        Hop size</span>
<span class="sd">    F_min : float or int</span>
<span class="sd">        Minimal frequency</span>
<span class="sd">    F_max : float or int</span>
<span class="sd">        Maximal frequency</span>
<span class="sd">    R : int</span>
<span class="sd">        Frequency resolution given in cents</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Y_LF_IF_bin : ndarray</span>
<span class="sd">        Binned log-frequency spectrogram using instantaneous frequency (shape: [freq, time])</span>
<span class="sd">    F_coef_hertz : ndarray</span>
<span class="sd">        Frequency axis in Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># calculate number of bins on log frequency axis</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">frequency_to_bin_index</span><span class="p">(</span><span class="n">F_max</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">F_min</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># center frequencies of the final bins</span>
    <span class="n">F_coef_hertz</span> <span class="o">=</span> <span class="n">F_min</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">*</span> <span class="n">R</span> <span class="o">/</span> <span class="mi">1200</span><span class="p">))</span>

    <span class="c1"># calculate heterodyned phase increment (hpi)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k</span> <span class="o">/</span> <span class="n">N</span>  <span class="c1"># center frequency for each bin in rad</span>
    <span class="n">hpi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">H</span>

    <span class="c1"># reduce hpi to -pi:pi range</span>
    <span class="c1"># this is much faster than using the modulo function below, but gives the same result</span>
    <span class="c1"># hpi = np.mod(hpi + np.pi, 2 * np.pi) - np.pi</span>
    <span class="n">hpi</span> <span class="o">=</span> <span class="n">hpi</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">hpi</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># calculate instantaneous frequencies in Hz</span>
    <span class="n">inst_f</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega</span> <span class="o">+</span> <span class="n">hpi</span> <span class="o">/</span> <span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fs</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="c1"># repeat the first time frame to match dimensions of X</span>
    <span class="n">inst_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">inst_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">inst_f</span><span class="p">))</span>

    <span class="c1"># mask frequencies that are not relevant</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">inst_f</span> <span class="o">&gt;=</span> <span class="n">F_min</span><span class="p">,</span> <span class="n">inst_f</span> <span class="o">&lt;</span> <span class="n">F_max</span><span class="p">)</span>
    <span class="n">inst_f</span> <span class="o">*=</span> <span class="n">mask</span>
    <span class="c1"># set 0 to nan, so it does stay at nan in the bin assignment calculation</span>
    <span class="n">inst_f</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inst_f</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># find which inst_f values belong to which bin</span>
    <span class="n">bin_assignment</span> <span class="o">=</span> <span class="n">frequency_to_bin_index</span><span class="p">(</span><span class="n">inst_f</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">F_min</span><span class="p">)</span>
    <span class="c1"># we map the discarded values to an extra bin that we remove before returning the binned spectrogram</span>
    <span class="n">bin_assignment</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">inst_f</span><span class="p">))]</span> <span class="o">=</span> <span class="n">B</span>

    <span class="c1"># perform binning on power spectrogram for each time frame separately</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">Y_LF_IF_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">Y_LF_IF_bin</span><span class="p">[:,</span> <span class="n">t</span><span class="p">],</span> <span class="n">bin_assignment</span><span class="p">[:,</span> <span class="n">t</span><span class="p">],</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Y_LF_IF_bin</span><span class="p">[:</span><span class="n">B</span><span class="p">,</span> <span class="p">:],</span> <span class="n">F_coef_hertz</span></div>


<div class="viewcode-block" id="compute_salience_from_logfreq_spec"><a class="viewcode-back" href="../../index_salience.html#libf0.salience.compute_salience_from_logfreq_spec">[docs]</a><span class="k">def</span> <span class="nf">compute_salience_from_logfreq_spec</span><span class="p">(</span><span class="n">lf_spec</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">n_harmonics</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">harmonic_win_len</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute salience representation using harmonic summation following [1]</span>

<span class="sd">    [1] J. Salamon and E. Gomez,</span>
<span class="sd">        &quot;Melody Extraction From Polyphonic Music Signals Using Pitch Contour Characteristics.&quot;</span>
<span class="sd">        IEEE Transactions on Audio, Speech, and Language Processing, vol. 20, no. 6, pp. 1759–1770, Aug. 2012.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lf_spec : ndarray</span>
<span class="sd">        (F, T) log-spectrogram</span>
<span class="sd">    R : int</span>
<span class="sd">        Frequency resolution given in cents</span>
<span class="sd">    n_harmonics : int</span>
<span class="sd">        Number of harmonics</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Weighting parameter for harmonics</span>
<span class="sd">    beta : float</span>
<span class="sd">        Compression parameter for spectrogram magnitudes</span>
<span class="sd">    gamma : float</span>
<span class="sd">        Magnitude threshold</span>
<span class="sd">    harmonic_win_len : int</span>
<span class="sd">        Length of a frequency weighting window in bins</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Z : ndarray</span>
<span class="sd">        (F, T) salience representation of the input spectrogram</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># magnitude thresholding and compression</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
    <span class="n">threshold_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lf_spec</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lf_spec</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">gamma</span>
    <span class="n">lf_spec</span> <span class="o">=</span> <span class="n">lf_spec</span><span class="o">**</span><span class="n">beta</span> <span class="o">*</span> <span class="n">threshold_mask</span>

    <span class="c1"># compute window</span>
    <span class="n">max_diff_bins</span> <span class="o">=</span> <span class="n">harmonic_win_len</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">max_diff_bins</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># cosine^2 window</span>

    <span class="c1"># compute indices of harmonics</span>
    <span class="n">harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_harmonics</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1200</span> <span class="o">/</span> <span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">weighting_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lf_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_diff_bins</span><span class="p">))</span>

    <span class="c1"># compute weights</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">harmonics</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">h</span><span class="o">+</span><span class="n">harmonic_win_len</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighting_vec</span><span class="p">):</span>
            <span class="k">break</span>  <span class="c1"># we reached the maximum length available</span>
        <span class="n">weighting_vec</span><span class="p">[</span><span class="n">h</span><span class="p">:</span><span class="n">h</span><span class="o">+</span><span class="n">harmonic_win_len</span><span class="p">]</span> <span class="o">+=</span> <span class="n">window</span> <span class="o">*</span> <span class="n">alpha</span><span class="o">**</span><span class="n">idx</span>

    <span class="c1"># correlate lf_spec with the weighting vector on the frequency axis</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">correlate1d</span><span class="p">(</span><span class="n">lf_spec</span><span class="p">,</span> <span class="n">weighting_vec</span><span class="p">[:],</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=-</span><span class="nb">len</span><span class="p">(</span><span class="n">weighting_vec</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">max_diff_bins</span><span class="p">)</span>

    <span class="c1"># magnitude thresholding and compression</span>
    <span class="n">threshold_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Z</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">gamma</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">**</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">threshold_mask</span>

    <span class="k">return</span> <span class="n">Z</span></div>


<div class="viewcode-block" id="define_transition_matrix"><a class="viewcode-back" href="../../index_salience.html#libf0.salience.define_transition_matrix">[docs]</a><span class="k">def</span> <span class="nf">define_transition_matrix</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">score_low</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">score_high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate transition matrix for dynamic programming</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    B : int</span>
<span class="sd">        Number of bins</span>
<span class="sd">    tol : int</span>
<span class="sd">        Tolerance parameter for transition matrix (Default value = 0)</span>
<span class="sd">    score_low : float</span>
<span class="sd">        Score (low) for transition matrix (Default value = 0.01)</span>
<span class="sd">    score_high : float</span>
<span class="sd">        Score (high) for transition matrix (Default value = 1.0)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    T : ndarray</span>
<span class="sd">        (B, B) Transition matrix</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    [FMP] Notebook: C8/C8S2_FundFreqTracking.ipynb</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">B</span><span class="p">,))</span> <span class="o">*</span> <span class="n">score_low</span>
    <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">tol</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">tol</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span> <span class="o">*</span> <span class="n">score_high</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">toeplitz</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">T</span></div>


<div class="viewcode-block" id="compute_trajectory_dp"><a class="viewcode-back" href="../../index_salience.html#libf0.salience.compute_trajectory_dp">[docs]</a><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">compute_trajectory_dp</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory tracking using dynamic programming</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Z : ndarray</span>
<span class="sd">        Salience representation</span>
<span class="sd">    T : ndarray</span>
<span class="sd">        Transisition matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    eta_DP : ndarray</span>
<span class="sd">        Trajectory indices</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    [FMP] Notebook: C8/C8S2_FundFreqTracking.ipynb</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">B</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">eps_machine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
    <span class="n">Z_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Z</span> <span class="o">+</span> <span class="n">eps_machine</span><span class="p">)</span>
    <span class="n">T_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="n">eps_machine</span><span class="p">)</span>

    <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
    <span class="n">D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_log</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
            <span class="n">D</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">T_log</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">D</span><span class="p">[:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">Z_log</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
            <span class="n">E</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">T_log</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">D</span><span class="p">[:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># backtracking</span>
    <span class="n">eta_DP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">eta_DP</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">D</span><span class="p">[:,</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">eta_DP</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">eta_DP</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="n">n</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">eta_DP</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_trajectory_cr"><a class="viewcode-back" href="../../index_salience.html#libf0.salience.compute_trajectory_cr">[docs]</a><span class="k">def</span> <span class="nf">compute_trajectory_cr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">T_coef</span><span class="p">,</span> <span class="n">F_coef_hertz</span><span class="p">,</span> <span class="n">constraint_region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">tol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_low</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">score_high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory tracking with constraint regions</span>
<span class="sd">    Notebook: C8/C8S2_FundFreqTracking.ipynb</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Z  : ndarray</span>
<span class="sd">        Salience representation</span>
<span class="sd">    T_coef : ndarray</span>
<span class="sd">        Time axis</span>
<span class="sd">    F_coef_hertz : ndarray</span>
<span class="sd">        Frequency axis in Hz</span>
<span class="sd">    constraint_region : ndarray or None</span>
<span class="sd">        Constraint regions, row-format: (t_start_sec, t_end_sec, f_start_hz, f_end_hz)</span>
<span class="sd">        (Default value = None)</span>
<span class="sd">    tol : int</span>
<span class="sd">        Tolerance parameter for transition matrix (Default value = 5)</span>
<span class="sd">    score_low : float</span>
<span class="sd">        Score (low) for transition matrix (Default value = 0.01)</span>
<span class="sd">    score_high : float</span>
<span class="sd">        Score (high) for transition matrix (Default value = 1.0)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    eta : ndarray</span>
<span class="sd">        Trajectory indices, unvoiced frames are indicated with -1</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    [FMP] Notebook: C8/C8S2_FundFreqTracking.ipynb</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># do tracking within every constraint region</span>
    <span class="k">if</span> <span class="n">constraint_region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># initialize contour, unvoiced frames are indicated with -1</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T_coef</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constraint_region</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="n">constraint_region</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># sec</span>
            <span class="n">t_end</span> <span class="o">=</span> <span class="n">constraint_region</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># sec</span>
            <span class="n">f_start</span> <span class="o">=</span> <span class="n">constraint_region</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Hz</span>
            <span class="n">f_end</span> <span class="o">=</span> <span class="n">constraint_region</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Hz</span>

            <span class="c1"># convert start/end values to indices</span>
            <span class="n">t_start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">T_coef</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">))</span>
            <span class="n">t_end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">T_coef</span> <span class="o">-</span> <span class="n">t_end</span><span class="p">))</span>
            <span class="n">f_start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">F_coef_hertz</span> <span class="o">-</span> <span class="n">f_start</span><span class="p">))</span>
            <span class="n">f_end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">F_coef_hertz</span> <span class="o">-</span> <span class="n">f_end</span><span class="p">))</span>

            <span class="c1"># track in salience part</span>
            <span class="n">cur_Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">f_start_idx</span><span class="p">:</span><span class="n">f_end_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t_start_idx</span><span class="p">:</span><span class="n">t_end_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">define_transition_matrix</span><span class="p">(</span><span class="n">cur_Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                                         <span class="n">score_low</span><span class="o">=</span><span class="n">score_low</span><span class="p">,</span> <span class="n">score_high</span><span class="o">=</span><span class="n">score_high</span><span class="p">)</span>
            <span class="n">cur_eta</span> <span class="o">=</span> <span class="n">compute_trajectory_dp</span><span class="p">(</span><span class="n">cur_Z</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

            <span class="c1"># fill contour</span>
            <span class="n">eta</span><span class="p">[</span><span class="n">t_start_idx</span><span class="p">:</span><span class="n">t_end_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_start_idx</span> <span class="o">+</span> <span class="n">cur_eta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">define_transition_matrix</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">score_low</span><span class="o">=</span><span class="n">score_low</span><span class="p">,</span> <span class="n">score_high</span><span class="o">=</span><span class="n">score_high</span><span class="p">)</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">compute_trajectory_dp</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eta</span></div>


<div class="viewcode-block" id="frequency_to_bin_index"><a class="viewcode-back" href="../../index_salience.html#libf0.salience.frequency_to_bin_index">[docs]</a><span class="k">def</span> <span class="nf">frequency_to_bin_index</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">F_ref</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binning function with variable frequency resolution</span>
<span class="sd">        Note: Indexing starts with 0 (opposed to [FMP, Eq. (8.49)])</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    F : float or ndarray</span>
<span class="sd">        Frequency in Hz</span>
<span class="sd">    R : float</span>
<span class="sd">        Frequency resolution in cents (Default value = 10.0)</span>
<span class="sd">    F_ref : float</span>
<span class="sd">        Reference frequency in Hz (Default value = 55.0)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        bin_index (int): Index for bin (starting with index 0)</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    [FMP] Notebook: C8/C8S2_SalienceRepresentation.ipynb</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bin_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">1200</span> <span class="o">/</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">F</span> <span class="o">/</span> <span class="n">F_ref</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bin_index</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2022, Sebastian Rosenzweig, Simon Schwär, Meinard Müller

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>